#!/bin/bash

echo "üöÄ –ó–∞–ø—É—Å–∫ –æ–±—É—á–µ–Ω–∏—è —Ä–µ–≥—Ä–µ—Å—Å–∏–æ–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏ –Ω–∞ Vast.ai"
echo "=================================================="

# –ü—Ä–æ–≤–µ—Ä–∫–∞ SSH —Ç—É–Ω–Ω–µ–ª—è –¥–ª—è –ë–î
echo "üì° –ü—Ä–æ–≤–µ—Ä–∫–∞ SSH —Ç—É–Ω–Ω–µ–ª—è –¥–ª—è –ë–î..."
if ! nc -z localhost 5555 2>/dev/null; then
    echo "‚ùå SSH —Ç—É–Ω–Ω–µ–ª—å –¥–ª—è –ë–î –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω!"
    echo "–ó–∞–ø—É—Å—Ç–∏—Ç–µ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ:"
    echo "ssh -p 27681 root@79.116.73.220 -R 5555:localhost:5555 -N"
    exit 1
fi
echo "‚úÖ SSH —Ç—É–Ω–Ω–µ–ª—å –∞–∫—Ç–∏–≤–µ–Ω"

# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É –∏ –∑–∞–ø—É—Å–∫
echo ""
echo "üîÑ –ü–æ–¥–∫–ª—é—á–∞—é—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É –∏ –∑–∞–ø—É—Å–∫–∞—é –æ–±—É—á–µ–Ω–∏–µ..."
ssh -p 27681 root@79.116.73.220 << 'ENDSSH'
echo "üìÇ –ü–µ—Ä–µ—Ö–æ–¥ –≤ —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é..."
cd /workspace/crypto_trading

echo "üêç –ê–∫—Ç–∏–≤–∞—Ü–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
source /workspace/venv/bin/activate

echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ GPU..."
python -c "import tensorflow as tf; print(f'TensorFlow {tf.__version__}'); print(f'GPU –¥–æ—Å—Ç—É–ø–µ–Ω: {len(tf.config.list_physical_devices(\"GPU\"))} —É—Å—Ç—Ä–æ–π—Å—Ç–≤')"

echo ""
echo "üöÄ –ó–ê–ü–£–°–ö –û–ë–£–ß–ï–ù–ò–Ø –†–ï–ì–†–ï–°–°–ò–û–ù–ù–û–ô –ú–û–î–ï–õ–ò"
echo "======================================="
echo "–ú–æ–¥–µ–ª–∏: buy_return_predictor –∏ sell_return_predictor"
echo "–ó–∞–¥–∞—á–∞: –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ expected returns"
echo ""

# –ó–∞–ø—É—Å–∫ –æ–±—É—á–µ–Ω–∏—è
python train_universal_transformer.py --config config.yaml

echo ""
echo "‚úÖ –û–±—É—á–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
ENDSSH