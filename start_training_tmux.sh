#!/bin/bash

echo "üöÄ –ó–∞–ø—É—Å–∫ –æ–±—É—á–µ–Ω–∏—è —á–µ—Ä–µ–∑ tmux (—Å –∑–∞—â–∏—Ç–æ–π –æ—Ç —Ä–∞–∑—Ä—ã–≤–∞)"
echo "===================================================="
echo ""

# –£–±–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π —Ç—É–Ω–Ω–µ–ª—å –µ—Å–ª–∏ –µ—Å—Ç—å
pkill -f "ssh.*5555:localhost:5555"
sleep 1

# –°–æ–∑–¥–∞–µ–º SSH —Ç—É–Ω–Ω–µ–ª—å –¥–ª—è –ë–î
echo "üîÑ –°–æ–∑–¥–∞–Ω–∏–µ SSH —Ç—É–Ω–Ω–µ–ª—è –¥–ª—è –ë–î..."
ssh -p 27681 root@79.116.73.220 -R 5555:localhost:5555 -N &
SSH_PID=$!
echo "‚úÖ –¢—É–Ω–Ω–µ–ª—å —Å–æ–∑–¥–∞–Ω (PID: $SSH_PID)"
sleep 3

# –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±—É—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ tmux
echo ""
echo "üì∫ –ó–∞–ø—É—Å–∫ –æ–±—É—á–µ–Ω–∏—è –≤ tmux —Å–µ—Å—Å–∏–∏..."
ssh -p 27681 root@79.116.73.220 << 'EOF'
# –ó–∞–≤–µ—Ä—à–∞–µ–º —Å—Ç–∞—Ä—É—é —Å–µ—Å—Å–∏—é –µ—Å–ª–∏ –µ—Å—Ç—å
tmux kill-session -t ml_training 2>/dev/null

# –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é tmux —Å–µ—Å—Å–∏—é
tmux new-session -d -s ml_training "cd /workspace/crypto_trading && source /workspace/venv/bin/activate && echo 'üöÄ –ù–∞—á–∞–ª–æ –æ–±—É—á–µ–Ω–∏—è: '$(date) && python train_universal_transformer.py 2>&1 | tee logs/training_tmux.log"

echo ""
echo "‚úÖ –û–±—É—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–æ –≤ tmux —Å–µ—Å—Å–∏–∏ 'ml_training'"
echo ""
echo "üìã –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:"
echo "   –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Å—Å–∏–∏: tmux attach -t ml_training"
echo "   –û—Ç–∫–ª—é—á–∏—Ç—å—Å—è –æ—Ç —Å–µ—Å—Å–∏–∏: Ctrl+B, –∑–∞—Ç–µ–º D"
echo "   –°–ø–∏—Å–æ–∫ —Å–µ—Å—Å–∏–π: tmux ls"
echo "   –ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–µ—Å—Å–∏—é: tmux kill-session -t ml_training"
echo ""
echo "üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:"
echo "   tail -f /workspace/crypto_training/logs/training_tmux.log"
echo ""
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞:"
tmux ls
EOF

echo ""
echo "=================="
echo "‚úÖ –ó–∞–ø—É—Å–∫ –∑–∞–≤–µ—Ä—à–µ–Ω"
echo "=================="
echo ""
echo "‚ö†Ô∏è  SSH —Ç—É–Ω–Ω–µ–ª—å –¥–ª—è –ë–î —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ñ–æ–Ω–µ (PID: $SSH_PID)"
echo ""
echo "üí° –ï—Å–ª–∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –ø—Ä–æ–ø–∞–¥–µ—Ç:"
echo "   1. –û–±—É—á–µ–Ω–∏–µ –ü–†–û–î–û–õ–ñ–ò–¢–°–Ø –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"
echo "   2. –ü—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç–µ —Ç—É–Ω–Ω–µ–ª—å:"
echo "      ssh -p 27681 root@79.116.73.220 -R 5555:localhost:5555 -N"
echo "   3. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ tmux —Å–µ—Å—Å–∏–∏:"
echo "      ssh -p 27681 root@79.116.73.220"
echo "      tmux attach -t ml_training"
echo ""
echo "üìä –î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å:"
echo "   ssh -p 27681 root@79.116.73.220 'tail -f /workspace/crypto_training/logs/training_tmux.log'"