#!/bin/bash
# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ SSH Ñ‚ÑƒÐ½Ð½ÐµÐ»Ñ Ðº Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ð¹ Ð‘Ð”

echo "ðŸ”— ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° SSH Ñ‚ÑƒÐ½Ð½ÐµÐ»Ñ Ð´Ð»Ñ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ðº Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ð¹ PostgreSQL..."
echo "==========================================================="

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ PostgreSQL Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾
if ! pg_isready -p 5555 -h localhost > /dev/null 2>&1; then
    echo "âŒ PostgreSQL Ð½Ðµ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ 5555!"
    echo "Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ PostgreSQL ÐºÐ¾Ð¼Ð°Ð½Ð´Ð¾Ð¹: pg_ctl start -D /usr/local/var/postgres"
    exit 1
fi

echo "âœ… PostgreSQL Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ 5555"

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¾Ð±Ñ€Ð°Ñ‚Ð½Ñ‹Ð¹ SSH Ñ‚ÑƒÐ½Ð½ÐµÐ»ÑŒ
# Ð­Ñ‚Ð¾ Ð¿Ð¾Ð·Ð²Ð¾Ð»Ð¸Ñ‚ ÑÐµÑ€Ð²ÐµÑ€Ñƒ Vast.ai Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð°Ñ‚ÑŒÑÑ Ðº Ð²Ð°ÑˆÐµÐ¹ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ð¹ Ð‘Ð”
echo ""
echo "ðŸ“¡ Ð¡Ð¾Ð·Ð´Ð°ÑŽ Ð¾Ð±Ñ€Ð°Ñ‚Ð½Ñ‹Ð¹ SSH Ñ‚ÑƒÐ½Ð½ÐµÐ»ÑŒ..."
echo "Ð¡ÐµÑ€Ð²ÐµÑ€ ÑÐ¼Ð¾Ð¶ÐµÑ‚ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð°Ñ‚ÑŒÑÑ Ðº Ð‘Ð” Ñ‡ÐµÑ€ÐµÐ· localhost:5555"
echo ""
echo "ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ Ctrl+C Ð´Ð»Ñ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Ñ‚ÑƒÐ½Ð½ÐµÐ»Ñ"
echo ""

ssh -p 27681 root@79.116.73.220 -R 5555:localhost:5555 -N -v -o ServerAliveInterval=30 -o ServerAliveCountMax=3 2>&1 | grep -E "remote forward|forwarding|success"