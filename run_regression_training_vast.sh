#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –æ–±—É—á–µ–Ω–∏—è —Ä–µ–≥—Ä–µ—Å—Å–∏–æ–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏ –Ω–∞ Vast.ai

echo "üöÄ –ó–∞–ø—É—Å–∫ –æ–±—É—á–µ–Ω–∏—è —Ä–µ–≥—Ä–µ—Å—Å–∏–æ–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏ –Ω–∞ Vast.ai"
echo "=================================================="

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î..."
if ! pg_isready -p 5555 -h localhost > /dev/null 2>&1; then
    echo "‚ùå PostgreSQL –Ω–µ –∑–∞–ø—É—â–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ –Ω–∞ –ø–æ—Ä—Ç—É 5555!"
    echo "–ó–∞–ø—É—Å—Ç–∏—Ç–µ –ë–î –∫–æ–º–∞–Ω–¥–æ–π:"
    echo "  pg_ctl start -D /usr/local/var/postgres"
    exit 1
fi
echo "‚úÖ –õ–æ–∫–∞–ª—å–Ω–∞—è –ë–î –¥–æ—Å—Ç—É–ø–Ω–∞"

# –ú–µ–Ω—é –≤—ã–±–æ—Ä–∞
echo ""
echo "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:"
echo "1) –ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–±—É—á–µ–Ω–∏–µ"
echo "2) –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä"
echo "3) –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å GPU"
echo "4) –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ–±—É—á–µ–Ω–∏—è"
echo "5) –°–∫–∞—á–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã"
echo ""
read -p "–í–∞—à –≤—ã–±–æ—Ä (1-5): " choice

case $choice in
    1)
        echo ""
        echo "üß† –ó–∞–ø—É—Å–∫–∞—é –æ–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π —Ä–µ–≥—Ä–µ—Å—Å–∏–∏..."
        echo ""
        echo "‚ö†Ô∏è  –í–ê–ñ–ù–û: –û—Ç–∫—Ä–æ–π—Ç–µ –ù–û–í–´–ô —Ç–µ—Ä–º–∏–Ω–∞–ª –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:"
        echo "    ./setup_remote_db_tunnel.sh"
        echo ""
        echo "–≠—Ç–æ —Å–æ–∑–¥–∞—Å—Ç SSH —Ç—É–Ω–Ω–µ–ª—å –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î"
        echo ""
        read -p "–ù–∞–∂–º–∏—Ç–µ Enter –∫–æ–≥–¥–∞ —Ç—É–Ω–Ω–µ–ª—å –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω..."
        
        echo ""
        echo "üì° –ü–æ–¥–∫–ª—é—á–∞—é—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É –∏ –∑–∞–ø—É—Å–∫–∞—é –æ–±—É—á–µ–Ω–∏–µ..."
        ssh -p 27681 root@79.116.73.220 -t "cd /workspace/crypto_trading && source /workspace/venv/bin/activate && export TF_CPP_MIN_LOG_LEVEL=1 && python train_universal_transformer.py --config remote_config.yaml"
        ;;
    
    2)
        echo ""
        echo "üì§ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
        ./sync_to_vast.sh
        ;;
    
    3)
        echo ""
        echo "üñ•Ô∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ GPU..."
        ssh -p 27681 root@79.116.73.220 nvidia-smi
        ;;
    
    4)
        echo ""
        echo "üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ–±—É—á–µ–Ω–∏—è..."
        echo "–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Ç–æ–¥:"
        echo "1) –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏"
        echo "2) TensorBoard (—Ç—Ä–µ–±—É–µ—Ç —Ç—É–Ω–Ω–µ–ª—å)"
        echo "3) Monitor script"
        read -p "–í–∞—à –≤—ã–±–æ—Ä (1-3): " monitor_choice
        
        case $monitor_choice in
            1)
                ssh -p 27681 root@79.116.73.220 "cd /workspace/crypto_trading && tail -f logs/training_*/training.log"
                ;;
            2)
                echo ""
                echo "üìä –°–æ–∑–¥–∞—é —Ç—É–Ω–Ω–µ–ª—å –¥–ª—è TensorBoard..."
                echo "–û—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ: http://localhost:6006"
                echo ""
                ssh -p 27681 root@79.116.73.220 -L 6006:localhost:16006 -N
                ;;
            3)
                ssh -p 27681 root@79.116.73.220 -t "cd /workspace/crypto_trading && source /workspace/venv/bin/activate && python monitor_training.py"
                ;;
        esac
        ;;
    
    5)
        echo ""
        echo "üì• –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤..."
        echo ""
        
        # –°–æ–∑–¥–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
        mkdir -p trained_model
        mkdir -p plots
        mkdir -p logs
        
        # –°–∫–∞—á–∏–≤–∞–µ–º –º–æ–¥–µ–ª–∏
        echo "üì¶ –°–∫–∞—á–∏–≤–∞—é –æ–±—É—á–µ–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏..."
        rsync -avz -e "ssh -p 27681" root@79.116.73.220:/workspace/crypto_trading/trained_model/ ./trained_model/
        
        # –°–∫–∞—á–∏–≤–∞–µ–º –≥—Ä–∞—Ñ–∏–∫–∏
        echo "üìä –°–∫–∞—á–∏–≤–∞—é –≥—Ä–∞—Ñ–∏–∫–∏..."
        rsync -avz -e "ssh -p 27681" root@79.116.73.220:/workspace/crypto_trading/logs/training_*/plots/ ./plots/
        
        # –°–∫–∞—á–∏–≤–∞–µ–º –ª–æ–≥–∏
        echo "üìù –°–∫–∞—á–∏–≤–∞—é –ª–æ–≥–∏..."
        rsync -avz -e "ssh -p 27681" root@79.116.73.220:/workspace/crypto_trading/logs/training_*/ ./logs/
        
        echo ""
        echo "‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω—ã!"
        ;;
    
    *)
        echo "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä!"
        exit 1
        ;;
esac