# 🚀 ML Crypto Trading System - Полный обзор проекта

## 📋 Описание проекта

**ML Crypto Trading System** - это продвинутая система машинного обучения для прогнозирования движения цен криптовалют на фьючерсном рынке. Система использует 49 технических индикаторов и современную архитектуру Temporal Fusion Transformer (TFT) для предсказания ожидаемой доходности (expected returns) с учетом сложной стратегии частичных закрытий позиций.

## 🎯 Основные возможности

1. **Автоматическая загрузка данных** с Bybit futures (51 криптовалюта, 3 года истории)
2. **Расчет 49 технических индикаторов** (трендовые, осцилляторы, объемные, волатильность)
3. **Expected Returns** - расчет ожидаемой доходности с учетом:
   - Частичных закрытий (20% на +1.2%, 30% на +2.4%, 30% на +3.5%)
   - Защиты прибыли (breakeven, profit locking)
   - Риск-профиля (SL: ±1.1%, TP: ±5.8%)
4. **TFT архитектура** с интерпретируемым attention механизмом
5. **Визуализация в реальном времени** процесса обучения
6. **GPU обучение** через Vast.ai (RTX 4090)
7. **Аналитика** через Metabase дашборды

## 🏗️ Архитектура системы

### Компоненты системы:

```
┌─────────────────┐     ┌──────────────────┐     ┌─────────────────┐
│   Bybit API     │────▶│  PostgreSQL DB   │────▶│ Data Processing │
│ (Futures Data)  │     │   (Port 5555)    │     │ (49 Indicators) │
└─────────────────┘     └──────────────────┘     └─────────────────┘
                                 │                         │
                                 ▼                         ▼
                        ┌──────────────────┐     ┌─────────────────┐
                        │    Metabase      │     │  Expected       │
                        │  (Analytics)     │     │  Returns Calc   │
                        └──────────────────┘     └─────────────────┘
                                                          │
                                 ┌────────────────────────┘
                                 ▼
                        ┌──────────────────┐     ┌─────────────────┐
                        │   TFT Model      │────▶│   Vast.ai GPU   │
                        │  (Transformer)   │     │  (RTX 4090)    │
                        └──────────────────┘     └─────────────────┘
                                 │
                                 ▼
                        ┌──────────────────┐
                        │  Predictions &   │
                        │  Visualizations  │
                        └──────────────────┘
```

### База данных PostgreSQL

**Таблицы:**
1. `raw_market_data` - сырые OHLCV данные
2. `processed_market_data` - данные с индикаторами и expected returns
3. `model_metadata` - информация о моделях
4. `training_sequences` - подготовленные последовательности
5. `model_predictions` - предсказания моделей

### Модель TFT (Temporal Fusion Transformer)

**Архитектура включает:**
- Variable Selection Network (VSN) - автоматический выбор признаков
- LSTM Encoder - захват временных зависимостей
- Multi-Head Attention - выявление важных паттернов
- Positional Encoding - кодирование временной информации
- Interpretable outputs - понимание важности признаков

**Параметры:**
- Входная последовательность: 60 баров (15 часов)
- Горизонт прогнозирования: 100 баров (25 часов)
- Размерность модели: 128
- Количество голов attention: 8
- Dropout rate: 0.2

## 💰 Торговая стратегия

### Риск-профиль:
- **BUY позиции**: SL = -1.1%, TP = +5.8%
- **SELL позиции**: SL = +1.1%, TP = -5.8%
- **Risk/Reward соотношение**: 1:5.3

### Частичные закрытия:
1. **20% позиции** закрывается на +1.2%
2. **30% позиции** закрывается на +2.4%
3. **30% позиции** закрывается на +3.5%
4. **20% остается** до TP (+5.8%) или SL

### Защита прибыли:
- **Breakeven** активируется после +1.2%
- **Profit locking** на уровнях +2.4% и +3.5%
- Динамическая корректировка SL

## 📊 Технические индикаторы (49 штук)

### Группы индикаторов:
1. **Трендовые (11)**: EMA, ADX, MACD, Ichimoku, SAR, Aroon, DPO
2. **Осцилляторы (9)**: RSI, Stochastic, CCI, Williams %R, ROC, Ultimate, MFI
3. **Волатильность (8)**: ATR, Bollinger Bands, Donchian Channel
4. **Объемные (4)**: OBV, CMF, Volume SMA, Volume Ratio
5. **Vortex (2)**: VI+, VI-
6. **Временные (3)**: hour, day_of_week, is_weekend
7. **Ценовые паттерны (3)**: изменения за 1, 4, 16 периодов
8. **Производные (9)**: различные соотношения и разности

## 🚀 Быстрый старт

### 1. Локальное обучение:
```bash
# Полный пайплайн
python run_futures_pipeline.py

# Или по шагам:
python init_database.py              # Инициализация БД
python download_data.py              # Загрузка данных
python prepare_dataset.py            # Расчет индикаторов
python train_universal_transformer.py --task regression  # Обучение
```

### 2. GPU обучение на Vast.ai:
```bash
# Терминал 1: SSH туннель для БД
./setup_remote_db_tunnel.sh

# Терминал 2: Запуск обучения
./run_training_on_vast.sh

# Терминал 3: Мониторинг (опционально)
./connect_vast.sh
# Открыть http://localhost:6006 для TensorBoard
```

### 3. Аналитика в Metabase:
```bash
cd metabase && docker-compose up -d
# Открыть http://localhost:3333
```

## 📈 Результаты и метрики

### Для регрессии (expected returns):
- **MAE**: Mean Absolute Error в процентах
- **RMSE**: Root Mean Square Error
- **R²**: коэффициент детерминации
- **Direction Accuracy**: точность предсказания направления

### Для классификации (profit/loss):
- **Accuracy**: общая точность
- **Precision**: точность положительных предсказаний
- **Recall**: полнота
- **F1 Score**: гармоническое среднее
- **AUC**: площадь под ROC кривой

### Ожидаемые результаты:
- Direction Accuracy: 55-65%
- MAE: 1.5-2.5%
- Win Rate с учетом частичных закрытий: 30-40%

## 🔧 Конфигурация

### Основные параметры (config.yaml):
```yaml
database:
  port: 5555              # PostgreSQL порт
  
risk_profile:
  leverage: 10            # Кредитное плечо
  stop_loss_pct_buy: 0.989   # -1.1%
  take_profit_pct_buy: 1.058  # +5.8%
  
model:
  sequence_length: 60     # 15 часов истории
  prediction_horizon: 100 # 25 часов прогноз
  batch_size: 32         # 64 для GPU
  epochs: 100
  
data_download:
  interval: '15'         # 15-минутные свечи
  days: 1095            # 3 года данных
  symbols: [...]        # 51 криптовалюта
```

## 📂 Структура файлов

```
LLM TRANSFORM/
├── 📊 Основные скрипты
│   ├── init_database.py              # Инициализация БД
│   ├── download_data.py              # Загрузка данных
│   ├── prepare_dataset.py            # Подготовка датасета
│   └── train_universal_transformer.py # ⭐ ГЛАВНЫЙ файл обучения
│
├── 🔧 Вспомогательные
│   ├── monitor_training.py           # Мониторинг обучения
│   ├── validate_futures_symbols.py   # Проверка символов
│   └── run_futures_pipeline.py       # Полный пайплайн
│
├── 🌐 Vast.ai интеграция
│   ├── connect_vast.sh               # SSH подключение
│   ├── sync_to_vast.sh               # Синхронизация файлов
│   ├── setup_remote_db_tunnel.sh     # БД туннель
│   └── run_training_on_vast.sh       # Запуск обучения
│
├── 📁 Директории
│   ├── logs/                         # Логи обучения
│   ├── plots/                        # Графики
│   ├── trained_model/                # Сохраненные модели
│   └── metabase/                     # Аналитика
│
└── 📄 Документация
    ├── README.md                     # Краткое описание
    ├── PROJECT_OVERVIEW.md           # Этот файл
    ├── PROJECT_STRUCTURE.md          # Структура проекта
    ├── PROJECT_STATUS.md             # Текущий статус
    ├── TRAINING_METHODS.md           # Методы обучения
    └── CLAUDE.md                     # Правила для AI
```

## 🛠️ Технологический стек

- **Python 3.8+**: основной язык
- **TensorFlow 2.19**: фреймворк ML
- **PostgreSQL**: база данных
- **Pandas/NumPy**: обработка данных
- **TA-Lib**: технические индикаторы
- **Matplotlib/Seaborn**: визуализация
- **Docker**: контейнеризация (Metabase)
- **Vast.ai**: облачные GPU

## 🚨 Важные замечания

1. **Всегда используем ФЬЮЧЕРСНЫЕ данные** (не спот)
2. **БД должна работать на порту 5555**
3. **Все улучшения только в `train_universal_transformer.py`**
4. **SSH туннель должен быть активен** при работе с Vast.ai
5. **Визуализация обновляется каждые 5 эпох**

## 📞 Поддержка и развитие

При возникновении проблем:
1. Проверить логи в `logs/training_*/`
2. Убедиться что БД доступна
3. Проверить SSH туннели для Vast.ai
4. Использовать `monitor_training.py` для диагностики

Проект активно развивается. Следующие шаги:
- Оптимизация гиперпараметров
- Добавление новых индикаторов
- Интеграция с торговым ботом
- A/B тестирование стратегий