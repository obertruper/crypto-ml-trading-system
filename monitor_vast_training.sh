#!/bin/bash

echo "üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ–±—É—á–µ–Ω–∏—è –Ω–∞ Vast.ai"
echo "================================="
echo ""

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ª–æ–≥–∞
get_latest_log() {
    ssh -p 27681 root@79.116.73.220 "ls -t /workspace/crypto_trading/logs/training_*/training.log 2>/dev/null | head -1"
}

# –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
while true; do
    clear
    echo "üìä –ú–û–ù–ò–¢–û–†–ò–ù–ì –û–ë–£–ß–ï–ù–ò–Ø –ú–û–î–ï–õ–ò"
    echo "============================="
    echo "–í—Ä–µ–º—è: $(date)"
    echo ""
    
    # –ü–æ–ª—É—á–∞–µ–º –ø—É—Ç—å –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É –ª–æ–≥—É
    LATEST_LOG=$(get_latest_log)
    
    if [ -n "$LATEST_LOG" ]; then
        echo "üìÅ –õ–æ–≥ —Ñ–∞–π–ª: $LATEST_LOG"
        echo ""
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –ª–æ–≥–∞
        echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è:"
        echo "--------------------"
        ssh -p 27681 root@79.116.73.220 "tail -20 $LATEST_LOG" 2>/dev/null || echo "–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –ª–æ–≥–∞"
        
        echo ""
        echo "üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:"
        echo "-------------"
        # –ò—â–µ–º –∫–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏
        ssh -p 27681 root@79.116.73.220 "grep -E '(–ó–∞–≥—Ä—É–∂–µ–Ω–æ|–∑–∞–ø–∏—Å–µ–π|—ç–ø–æ—Ö–∞|loss|accuracy|MAE)' $LATEST_LOG | tail -10" 2>/dev/null || echo "–ñ–¥–µ–º –º–µ—Ç—Ä–∏–∫–∏..."
        
    else
        echo "‚ö†Ô∏è –õ–æ–≥ —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—è–µ–º tmux —Å–µ—Å—Å–∏—é..."
        ssh -p 27681 root@79.116.73.220 "tmux ls" 2>/dev/null || echo "Tmux —Å–µ—Å—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
    fi
    
    echo ""
    echo "üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥... (Ctrl+C –¥–ª—è –≤—ã—Ö–æ–¥–∞)"
    echo ""
    echo "üí° –ö–æ–º–∞–Ω–¥—ã:"
    echo "  - –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Å—Å–∏–∏: ssh -p 27681 root@79.116.73.220 'tmux attach -t ml_training'"
    echo "  - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å GPU: ssh -p 27681 root@79.116.73.220 'nvidia-smi'"
    
    sleep 10
done