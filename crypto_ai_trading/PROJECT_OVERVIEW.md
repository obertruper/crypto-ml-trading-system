# Обзор проекта Crypto AI Trading

Этот документ представляет собой высокоуровневое описание архитектуры, компонентов и рабочего процесса проекта `crypto_ai_trading`. Он предназначен для быстрого введения в курс дела.

## 1. Общая цель

Проект представляет собой комплексную MLOps-систему для алгоритмической торговли криптовалютными фьючерсами. Ключевые цели:
- Прогнозирование движений цен с использованием продвинутых моделей глубокого обучения.
- Автоматизация процессов от сбора данных до обучения моделей и бэктестинга.
- Обеспечение высокой производительности и воспроизводимости экспериментов.
- Минимизация утечек данных (data leakage) на всех этапах.

## 2. Ключевые технологии

- **Машинное обучение:** PyTorch, Scikit-learn, Transformers (`PatchTST`).
- **Обработка данных:** Pandas, NumPy, SQLAlchemy.
- **База данных:** PostgreSQL для хранения сырых рыночных данных.
- **Хранение данных/кэш:** HDF5/Parquet (через `pyarrow`) и Pickle для кэширования обработанных датасетов и признаков.
- **Бэктестинг:** `vectorbt` и `ccxt` для симуляции торговых стратегий.
- **Мониторинг:** TensorBoard и `wandb` для отслеживания экспериментов.
- **Инфраструктура:** Docker, SSH для работы с удаленными серверами.

## 3. Архитектура и компоненты

Проект имеет модульную структуру, что упрощает его понимание и доработку.

### 3.1. Конфигурация (`config/`)

Система полностью управляется через YAML-файлы.
- `config.yaml`: Базовая конфигурация.
- `config_production.yaml`: Настройки для финального обучения и работы в "боевом" режиме.
- `config_test.yaml`, `config_antioverfit.yaml`: Специализированные конфигурации для разных сценариев.

### 3.2. Поток данных (`data/`)

Это один из самых сложных и важных модулей.
1.  **`data_loader.py`**: Загружает сырые 15-минутные OHLCV данные из **PostgreSQL**. Реализован механизм кэширования в `.pkl` файлы для ускорения повторных запусков.
2.  **`feature_engineering.py`**: Генерирует **более 150 признаков**, включая:
    - Стандартные технические индикаторы (SMA, RSI, MACD, BB и др.).
    - Признаки микроструктуры рынка (спред, токсичность потока ордеров).
    - Кросс-активные признаки (корреляция с BTC, анализ по секторам: DeFi, L1, Meme).
    - ML-оптимизированные признаки (экспонента Хёрста, фрактальная размерность).
3.  **Создание целевых переменных**: В `feature_engineering.py` реализован критически важный механизм создания **24 целевых переменных** (будущие доходности, направление, риски) **без утечки данных из будущего** (используется `shift(-n)`).
4.  **`dataset.py`**: Содержит кастомные классы `Dataset` для PyTorch (`TradingDataset`), которые:
    - Нарезают данные на окна (`context_window`).
    - Выполняют нормализацию с помощью `RobustScaler` (устойчив к выбросам), предотвращая утечку данных между train/val/test выборками.
    - Готовят данные для подачи в модель.

### 3.3. Стратегия моделирования (две модели)

Проект использует гибридную стратегию, сочетая две разные модели:

1.  **`UnifiedPatchTST` (Основная модель)**
    - **Архитектура**: Сложная модель на базе `PatchTST` (трансформер для временных рядов).
    - **Задача**: Многозадачное обучение (Multi-task learning). Предсказывает одновременно все 24 целевые переменные.
    - **Цель**: Дать комплексное "понимание" рынка.
    - **Запуск**: `run_unified_training.sh` -> `main.py`.

2.  **`DirectionPredictor` (Специализированная модель)**
    - **Архитектура**: Более простая модель, сфокусированная на одной задаче.
    - **Задача**: Классификация направления движения (UP, DOWN, FLAT).
    - **Ключевая особенность**: Использует кастомную функцию п��терь **`DirectionalTradingLoss`**, которая напрямую оптимизирует симулированную прибыльность с учетом комиссий.
    - **Запуск**: `train_direction_model.py` или `quick_start_direction.sh`.

**Предполагаемая общая стратегия**: Финальное торговое решение, скорее всего, является **ансамблем** или гибридом: `DirectionPredictor` дает основной сигнал для входа в сделку, а `UnifiedPatchTST` предоставляет дополнительную информацию для управления рисками, определения размера позиции и целей по прибыли.

### 3.4. Обучение (`training/`)

- **`optimized_trainer.py`**: Основной класс `Trainer` с поддержкой всех современных техник оптимизации (AMP, gradient accumulation, early stopping).
- **`train_direction_model.py`**: Содержит специализированный `DirectionModelTrainer`, который во время обучения отслеживает торговые метрики (Win Rate, Profit Factor).

## 4. Основной рабочий процесс (Execution Flow)

1.  **Подготовка данных (Кэширование)**:
    - Система сильно зависит от предварительно обработанных и сохраненных данных в `data/processed/`.
    - Если кэш отсутствует, его необходимо создать, запустив `python prepare_trading_data.py` или `python main.py --mode data`.

2.  **Обучение основной модели (`UnifiedPatchTST`)**:
    - Запускается через `run_unified_training.sh` или напрямую:
      ```bash
      python main.py --mode train --config config/config_production.yaml
      ```

3.  **Обучение модели направления (`DirectionPredictor`)**:
    - Запускается через `quick_start_direction.sh` или напрямую:
      ```bash
      python train_direction_model.py
      ```

4.  **Бэктестинг и оценка**:
    - `main.py` поддерживает режим `--mode backtest`, который использует обученную модель для проверки стратегии на исторических данных.
    - `evaluate_model.py` и `backtest_direction_strategy.py` служат для более детальной оценки.
