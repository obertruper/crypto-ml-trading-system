#!/bin/bash

echo "üîÑ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ SSH —Ç—É–Ω–Ω–µ–ª—è –¥–ª—è –ë–î"
echo "================================="

while true; do
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç—É–Ω–Ω–µ–ª—å
    if ! ssh -p 27681 root@79.116.73.220 "timeout 2 nc -zv localhost 5555" 2>&1 | grep -q "open"; then
        echo "‚ùå $(date): –¢—É–Ω–Ω–µ–ª—å –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º..."
        
        # –£–±–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
        pkill -f "ssh.*5555"
        sleep 2
        
        # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —Ç—É–Ω–Ω–µ–ª—å
        ssh -f -N -p 27681 root@79.116.73.220 -R 5555:localhost:5555 \
            -o ServerAliveInterval=30 \
            -o ServerAliveCountMax=3 \
            -o ExitOnForwardFailure=yes
        
        echo "‚úÖ $(date): –¢—É–Ω–Ω–µ–ª—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    else
        echo "‚úÖ $(date): –¢—É–Ω–Ω–µ–ª—å —Ä–∞–±–æ—Ç–∞–µ—Ç"
    fi
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥
    sleep 60
done