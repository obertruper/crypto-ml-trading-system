#!/bin/bash

echo "üöÄ –ó–∞–ø—É—Å–∫ –æ–±—É—á–µ–Ω–∏—è XGBoost v3 –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ"
echo "=================================================="

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–µ—Ä–∞
SERVER_HOST="ssh1.vast.ai"
SERVER_PORT=18645
SERVER_USER="root"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç—É–Ω–Ω–µ–ª–∏
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö SSH —Ç—É–Ω–Ω–µ–ª–µ–π..."
EXISTING_TUNNELS=$(ps aux | grep "ssh.*$SERVER_PORT.*5555" | grep -v grep | wc -l)

if [ $EXISTING_TUNNELS -eq 0 ]; then
    echo "üì° –°–æ–∑–¥–∞–Ω–∏–µ —Ç—É–Ω–Ω–µ–ª—è –¥–ª—è –ë–î..."
    # –°–æ–∑–¥–∞–µ–º –æ–±—Ä–∞—Ç–Ω—ã–π —Ç—É–Ω–Ω–µ–ª—å –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î —Å —Å–µ—Ä–≤–µ—Ä–∞
    ssh -f -N -p $SERVER_PORT -R 5555:localhost:5555 $SERVER_USER@$SERVER_HOST
    echo "‚úÖ –¢—É–Ω–Ω–µ–ª—å —Å–æ–∑–¥–∞–Ω (—É–¥–∞–ª–µ–Ω–Ω—ã–π –ø–æ—Ä—Ç 5555 -> –ª–æ–∫–∞–ª—å–Ω–∞—è –ë–î)"
    sleep 2
else
    echo "‚úÖ –¢—É–Ω–Ω–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
fi

# –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–æ–¥–∞
echo -e "\nüì§ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–æ–¥–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
rsync -avz --progress \
  --exclude='__pycache__' \
  --exclude='*.pyc' \
  --exclude='.git' \
  --exclude='logs/' \
  --exclude='cache/' \
  --exclude='*.pkl' \
  --exclude='*.csv' \
  --exclude='*.png' \
  xgboost_v3/ \
  -e "ssh -p $SERVER_PORT" \
  $SERVER_USER@$SERVER_HOST:~/xgboost_v3/

# –í—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞ –æ–±—É—á–µ–Ω–∏—è
echo -e "\nüéØ –í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º –æ–±—É—á–µ–Ω–∏—è:"
echo "1. üß™ –¢–µ—Å—Ç–æ–≤—ã–π (2 —Å–∏–º–≤–æ–ª–∞, –±—ã—Å—Ç—Ä–æ)"
echo "2. üéØ –ü—Ä–æ–¥–∞–∫—à–Ω (–≤—Å–µ —Å–∏–º–≤–æ–ª—ã, –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è)"
echo "3. üîß –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã"
read -p "–í–∞—à –≤—ã–±–æ—Ä (1-3): " MODE

case $MODE in
    1)
        COMMAND="cd ~/xgboost_v3 && python3 main.py"
        echo "üß™ –ó–∞–ø—É—Å–∫ –≤ —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ..."
        ;;
    2)
        COMMAND="cd ~/xgboost_v3 && python3 main.py --mode production"
        echo "üéØ –ó–∞–ø—É—Å–∫ –≤ –ø—Ä–æ–¥–∞–∫—à–Ω —Ä–µ–∂–∏–º–µ..."
        ;;
    3)
        echo "–í–≤–µ–¥–∏—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä: --gpu --epochs 2000):"
        read PARAMS
        COMMAND="cd ~/xgboost_v3 && python3 main.py $PARAMS"
        echo "üîß –ó–∞–ø—É—Å–∫ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏: $PARAMS"
        ;;
    *)
        echo "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä"
        exit 1
        ;;
esac

# –ó–∞–ø—É—Å–∫ –æ–±—É—á–µ–Ω–∏—è
echo -e "\nüöÄ –ó–∞–ø—É—Å–∫ –æ–±—É—á–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."
echo "–ö–æ–º–∞–Ω–¥–∞: $COMMAND"
echo "=================================================="

# –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è SSH —Å–µ—Å—Å–∏—è –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
ssh -p $SERVER_PORT $SERVER_USER@$SERVER_HOST -t "$COMMAND"

echo -e "\n‚úÖ –û–±—É—á–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo "üíæ –î–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:"
echo "   ./download_results.sh"