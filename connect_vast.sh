#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Vast.ai —Å–µ—Ä–≤–µ—Ä—É
# –ù–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä
# IP: 184.98.25.179 (–ø—Ä—è–º–æ–π) –∏–ª–∏ ssh8.vast.ai (proxy)
# SSH Port: 41575 (–ø—Ä—è–º–æ–π) –∏–ª–∏ 13641 (proxy)

# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
SSH_KEY="id_rsa"

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
if [ "$1" == "--key" ] && [ -n "$2" ]; then
    SSH_KEY="$2"
fi

echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
echo "‚ïë      –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Vast.ai —Å–µ—Ä–≤–µ—Ä         ‚ïë"
echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
echo ""
echo "IP –∞–¥—Ä–µ—Å: 184.98.25.179 (–ø—Ä—è–º–æ–π) / ssh8.vast.ai (proxy)"
echo "SSH –ø–æ—Ä—Ç: 41575 (–ø—Ä—è–º–æ–π) / 13641 (proxy)"
echo "–õ–æ–∫–∞–ª—å–Ω—ã–π —Ç—É–Ω–Ω–µ–ª—å: 8080 -> localhost:8080"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ SSH –∫–ª—é—á–∞
echo "üîë –ü—Ä–æ–≤–µ—Ä–∫–∞ SSH –∫–ª—é—á–∞: ~/.ssh/$SSH_KEY"
if [ -f ~/.ssh/$SSH_KEY ]; then
    echo "‚úì SSH –∫–ª—é—á –Ω–∞–π–¥–µ–Ω"
    echo "Fingerprint: $(ssh-keygen -lf ~/.ssh/$SSH_KEY.pub 2>/dev/null | awk '{print $2}')"
else
    echo "‚úó SSH –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ ~/.ssh/$SSH_KEY"
    exit 1
fi

# –ü—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
echo ""
echo "üöÄ –ü–æ–ø—ã—Ç–∫–∞ –ø—Ä—è–º–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è..."
echo "–ö–æ–º–∞–Ω–¥–∞: ssh -p 41575 root@184.98.25.179"
echo ""

ssh -i ~/.ssh/$SSH_KEY \
    -o ConnectTimeout=10 \
    -o StrictHostKeyChecking=no \
    -o UserKnownHostsFile=/dev/null \
    -p 41575 \
    root@184.98.25.179 \
    -L 8080:localhost:8080 \
    -L 6006:localhost:6006 \
    -L 8384:localhost:8384 || {
    
    echo ""
    echo "‚ùå –ü—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å"
    echo ""
    echo "üîÑ –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏..."
    echo "–ö–æ–º–∞–Ω–¥–∞: ssh -p 13641 root@ssh8.vast.ai"
    echo ""
    
    ssh -i ~/.ssh/$SSH_KEY \
        -o ConnectTimeout=10 \
        -o StrictHostKeyChecking=no \
        -o UserKnownHostsFile=/dev/null \
        -p 13641 \
        root@ssh8.vast.ai \
        -L 8080:localhost:8080 \
        -L 6006:localhost:6006 \
        -L 8384:localhost:8384 || {
        
        echo ""
        echo "‚ùå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏ —Ç–æ–∂–µ –Ω–µ —É–¥–∞–ª–æ—Å—å"
        echo ""
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        echo "‚ö†Ô∏è  –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ü–†–û–ë–õ–ï–ú–´"
        echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        echo ""
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö SSH –∫–ª—é—á–µ–π
        echo "üìÅ –î–æ—Å—Ç—É–ø–Ω—ã–µ SSH –∫–ª—é—á–∏:"
        ls -la ~/.ssh/*.pub | awk '{print "   - " $9}'
        echo ""
        
        echo "üîë Fingerprint —Ç–µ–∫—É—â–µ–≥–æ –∫–ª—é—á–∞ id_rsa:"
        ssh-keygen -lf ~/.ssh/id_rsa.pub
        echo ""
        
        echo "üí° –í–æ–∑–º–æ–∂–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è:"
        echo ""
        echo "1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ Vast.ai –∑–∞–≥—Ä—É–∂–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–ª—é—á:"
        echo "   ‚Ä¢ –ö–ª—é—á —É–∂–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞"
        echo "   ‚Ä¢ –û—Ç–∫—Ä–æ–π—Ç–µ: https://cloud.vast.ai/console/keys"
        echo "   ‚Ä¢ –í—Å—Ç–∞–≤—å—Ç–µ –ü–û–õ–ù–´–ô –∫–ª—é—á (–≤–∫–ª—é—á–∞—è ssh-rsa –∏ user@host)"
        echo "   ‚Ä¢ –ù–∞–∂–º–∏—Ç–µ Save/Update"
        echo "   ‚Ä¢ –ü–æ–¥–æ–∂–¥–∏—Ç–µ 2-3 –º–∏–Ω—É—Ç—ã –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è"
        echo ""
        echo "2. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –∫–ª—é—á–∏:"
        if [ -f ~/.ssh/vast_ai_key ]; then
            echo "   ./connect_vast.sh --key vast_ai_key"
        fi
        if [ -f ~/.ssh/vast_key ]; then
            echo "   ./connect_vast.sh --key vast_key"
        fi
        echo ""
        echo "3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å –∏–Ω—Å—Ç–∞–Ω—Å–∞:"
        echo "   ‚Ä¢ https://vast.ai/console/instances/"
        echo "   ‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–æ–≤—ã–π Instance ID"
        echo ""
        echo "4. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É –∏–∑ –∫–æ–Ω—Å–æ–ª–∏ Vast.ai"
        echo "   (–æ–Ω–∞ –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π proxy jump)"
        echo ""
        echo "üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Ä–≤–µ—Ä–µ:"
        echo "   IP: 184.98.25.179 (–ø—Ä—è–º–æ–π) / ssh8.vast.ai (proxy)"
        echo "   SSH –ø–æ—Ä—Ç: 41575 (–ø—Ä—è–º–æ–π) / 13641 (proxy)"
        echo "   –õ–æ–∫–∞–ª—å–Ω—ã–µ —Ç—É–Ω–Ω–µ–ª–∏:"
        echo "   - localhost:6006 -> TensorBoard"
        echo "   - localhost:8080 -> Web UI"
        echo "   - localhost:8384 -> Syncthing"
        echo ""
        
        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
        echo "üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ SSH:"
        echo "   ‚Ä¢ –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ SSH –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏: $(ls -ld ~/.ssh | awk '{print $1}')"
        echo "   ‚Ä¢ –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞: $(ls -l ~/.ssh/$SSH_KEY 2>/dev/null | awk '{print $1}')"
        echo ""
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
        if [ -f ~/.ssh/$SSH_KEY ]; then
            PERMS=$(stat -f %A ~/.ssh/$SSH_KEY 2>/dev/null || stat -c %a ~/.ssh/$SSH_KEY 2>/dev/null)
            if [ "$PERMS" != "600" ]; then
                echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–ª—é—á—É!"
                echo "   –í—ã–ø–æ–ª–Ω–∏—Ç–µ: chmod 600 ~/.ssh/$SSH_KEY"
                echo ""
            fi
        fi
        
        # –ö–æ–ø–∏—Ä—É–µ–º –∫–ª—é—á –≤ –±—É—Ñ–µ—Ä
        cat ~/.ssh/$SSH_KEY.pub | pbcopy
        echo "‚úÖ SSH –∫–ª—é—á —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!"
        echo ""
        echo "üìå –ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª—é—á–∞–º–∏:"
        echo "   https://cloud.vast.ai/console/keys"
    }
}